@using siges.Models
@using System.Globalization
@{
    ViewData["Title"] = "Órdenes de Servicio";
    List<OrdenServicio> ordenes = ViewData["ordenes"] as List<OrdenServicio>;
}

@section css{
    <link href="~/lib/bootstrap-table-1.12.1/dist/extensions/filter-control/bootstrap-table-filter-control.min.css" rel="stylesheet" />
    <link href="~/lib/bootstrap-select/dist/css/bootstrap-select.min.css" rel="stylesheet" />
}

    @Html.AntiForgeryToken()

    <div class="container">
        <div class="row">
            <div class="col">
                <h2>&Oacute;rdenes de Servicio</h2>
            </div>
            <div class="col align-self-center text-right">
                @if (!User.IsInRole("Operador"))
            {
                @if (User.IsInRole("Ventas"))
                {
                    <a class="btn bg-yellow margR-30px float" href='@Url.Action("Index", "Ventas")' data-toggle="tooltip" data-placement="bottom" title="Calendario" data-original-title="Tooltip on bottom"><i class="fas fa-calendar-alt"></i></a>
                }
                else
                {
                    <a class="btn bg-yellow margR-30px float" href='@Url.Action("CalendarioAllOS", "Servicio")' data-toggle="tooltip" data-placement="bottom" title="Calendario" data-original-title="Tooltip on bottom"><i class="fas fa-calendar-alt"></i></a>
                }
                @if (!User.IsInRole("Ventas"))
                {
                    @* <a class="btn btn-danger margR-30px float" href='@Url.Action("IndexListDOS", "Servicio")' data-toggle="tooltip" data-placement="bottom" title="Eliminadas" data-original-title="Tooltip on bottom"><i class="fas fa-minus"></i></a> *@
                    <a class="btn btn-success marg-Float float" href='@Url.Action("CreateOS", "Servicio")' data-toggle="tooltip" data-placement="bottom" title="Agregar" data-original-title="Tooltip on bottom"><i class="fas fa-plus"></i></a>
                }
            }
        </div>
    </div>
    <div class="row">
        <div class="col margBott4em">
            <table id="tableOrdenesServicio" data-search="true" data-toggle="table" data-show-columns="false" data-pagination="true" data-locale="es-MX" data-classes="table table-hover" data-page-size="5" data-page-list="[5,10,25]" data-show-footer="true" data-filter-control="true" data-filter-show="true" @*data-sort-name="folio"*@ data-show-search-clear-button="true">
                <thead>
                    <tr>
                        <th data-field="id" data-visible="false"></th>
                        <th data-field="folio" data-sortable="true" data-width="10%">Folio</th>
                        <th data-field="fecha" data-sortable="true" data-sorter="dateSort" data-width="5%" data-filter-control="input">Fecha</th>
                        <th data-field="cliente" data-sortable="true" data-width="13%" data-filter-control="select">Cliente</th>
                        <th data-field="documento" data-sortable="true" data-width="15%" data-filter-control="select">Contrato</th>
                        <th data-field="ubicacion" data-sortable="true" data-width="15%" data-filter-control="select">Ubicaci&oacute;n</th>
                        <th data-field="servicio" data-sortable="true" data-width="10%" data-filter-control="select">Servicio</th>
                        <th data-field="lineaNegocio" data-sortable="true" data-width="10%" data-filter-control="select">Línea de negocio</th>
                        <th data-field="estatus" data-sortable="true" data-width="5%" data-filter-control="select">Estatus</th>
                        <th data-field="creadoPor" data-sortable="true" data-width="15%" data-filter-control="select">Creado por</th>
                        <th class="mobileHidden" data-width="5%">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var orden in ordenes)
                    {
                        <tr>
                            <td>@orden.Id</td>
                            <td>@orden.Folio</td>
                            <td>@((orden.FechaInicio.HasValue) ? orden.FechaInicio.Value.Date.ToString("dd/MM/yyyy") : "Sin Fecha" )</td>
                            <td>@((orden.Cliente.RazonSocial != null) ? CultureInfo.CreateSpecificCulture("es-ES").TextInfo.ToTitleCase(orden.Cliente.RazonSocial.ToLower()) : orden.Cliente.RazonSocial)</td>
                            <td>@orden.Contrato.Nombre / @orden.Contrato.Tipo</td>
                            <td>@((orden.Ubicacion.Nombre != null) ? CultureInfo.CreateSpecificCulture("es-ES").TextInfo.ToTitleCase(orden.Ubicacion.Nombre.ToLower()) : orden.Ubicacion.Nombre)</td>
                            <td>@((orden.Servicio.Nombre != null) ? CultureInfo.CreateSpecificCulture("es-ES").TextInfo.ToTitleCase(orden.Servicio.Nombre.ToLower()) : orden.Servicio.Nombre)</td>
                            <td>@*(CultureInfo.CreateSpecificCulture("es-ES").TextInfo.ToTitleCase(*@@(orden.LineaNegocio.Nombre@*.ToLower())*@)</td>
                            <td>@(orden.EstatusServicio == "nocobrado" ? "No Cobrado" : orden.EstatusServicio == "cobrado" ? "Cobrado" : orden.EstatusServicio == "programado" ? "Programado" : orden.EstatusServicio == "reprogramado" ? "Reprogramado" : orden.EstatusServicio == "solicitado" ? "Solicitado" : orden.EstatusServicio == "cancelado" ? "Cancelado" : orden.EstatusServicio== "finalizado" ? "Finalizado" : orden.EstatusServicio == "facturado" ? "Facturado" : "Indefinido")</td>
                            <td>@(orden.PersonaComercial.Nombre != null ? CultureInfo.CreateSpecificCulture("es-ES").TextInfo.ToTitleCase(orden.PersonaComercial.Nombre.ToLower()) : orden.PersonaComercial.Nombre) @(orden.PersonaComercial.Paterno != null ? CultureInfo.CreateSpecificCulture("es-ES").TextInfo.ToTitleCase(orden.PersonaComercial.Paterno.ToLower()) : orden.PersonaComercial.Paterno)</td>
                            <td class="mobileHidden"><a class="btn btn-success float_Table" data-toggle="tooltip" data-placement="bottom" title="Acciones" data-original-title="Tooltip on bottom"><i class="fab fa-elementor"></i></a></td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@* @section Modals {
@if(User.IsInRole("Operador")){
<!-- Cambiar Estado Modal -->
<div class="modal fade" id="CambiarEstadoModal" tabindex="-1" role="dialog" aria-labelledby="CambiarEstadoModalTitulo" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="CambiarEstadoModalTitulo">Seleccionar servicio</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="jumbotron jumbotron-fluid">
          <div class="container">
            <form id="CambiarEstadoForm" action="@Url.Action("CambiarEstado","Operador")" method="post">
              <div class="form-group">
                <h5 class="display-4">Folio</h5>
                <select multiple class="form-control" id="cambiarEstadoFolio" name="OrdenServicioId" required>
                  @foreach(var ordenServicio in ViewData["OrdenServicioEnTiempo"] as List<OrdenPersona>){
                  <option class="d-flex justify-content-center p-2" value="@ordenServicio.OrdenServicio.Id">@ordenServicio.OrdenServicio.Folio</option>
                  }
                  @foreach (var ordenPersona in ViewData["ordenesPersona"] as List<OrdenPersona>) {
                  <option class="d-flex justify-content-center p-2" value="@ordenPersona.OrdenServicio.Id">@ordenPersona.OrdenServicio.Folio</option>
                  }
                </select>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-warning" data-dismiss="modal">Cerrar</button>
                <button type="submit" class="btn btn-success">Reportar</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
}
} *@

@section scripts{
    <script src="~/lib/bootstrap-table-1.12.1/dist/extensions/filter-control/bootstrap-table-filter-control.min.js"></script>
    <script src="~/lib/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
    <script src="~/js/moment-2.22.2/min/moment-with-locales.js"></script>
    <script src="~/js/listOrdenServicio.js"></script>
    <script>
        function dateSort(a, b, rowA, rowB) {
            var currentDate = moment(a.split('/')[2] + '-' + a.split('/')[1] + '-' + a.split('/')[0]);
            var nextDate = moment(b.split('/')[2] + '-' + b.split('/')[1] + '-' + b.split('/')[0]);
            if (currentDate.isSame(nextDate)) {
                return 0;
            } else if (currentDate.isBefore(nextDate)) {
                return -1;
            } else if (currentDate.isAfter(nextDate)) {
                return 1;
            }
        }
    </script>
    @if (User.IsInRole("Operador") || User.IsInRole("Ventas"))
    {
        <script>
            $('#tableOrdenesServicio').on('click-row.bs.table', (row, $element, field) => {
                Swal.fire({
                    title: `Orden: ${$element.folio}`,
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCloseButton: true,
                    closeButtonHtml: '<i class="fas fa-times"></i>',
                    html: `
                            <div class="form-row margTop40">
                                <div class="form-group col">
                                    <a href="@Url.Action("DownloadOSFormat","Servicio")?ordenId=${$element.id}" class="btn btn-success float" data-toggle="tooltip" data-placement="bottom" title="Descargar" data-original-title="Tooltip on bottom"><i class="fas fa-file-download"></i></a>
                                    <label class="d-block margTop5px">Descargar (ESP)</label>
                                </div>
                                <div class="form-group col">
                                    <a href="@Url.Action("DownloadOSFormatEnglish","Servicio")?ordenId=${$element.id}" class="btn btn-success float" data-toggle="tooltip" data-placement="bottom" title="Descargar" data-original-title="Tooltip on bottom"><i class="fas fa-file-download"></i></a>
                                    <label class="d-block margTop5px">Descargar (ENG)</label>
                                </div>
                               <div class="form-group col">
                                    <a href="@Url.Action("IndexDetailOS", "Servicio")?ordenId=${$element.id}" class="btn btn-success float" data-toggle="tooltip" data-placement="bottom" title="Detalles" data-original-title="Tooltip on bottom"><i class="fas fa-search"></i></a>
                                    <label class="d-block margTop5px">Detalles</label>
                                </div>
                            </div>

                        `
                });
            });

            $("#MenuCambiarEstadoOperador").on("click", () => {
                const listOS = @Html.Raw(ViewData["OrdenServicioEnTiempo"]);
                Swal.fire({
                    title: `Seleccionar Servicio`,
                    confirmButtonColor: "#67E7CF",
                    confirmButtonText: "Reportar",
                    cancelButtonText: "Cancelar",
                    reverseButtons: true,
                    showCancelButton: true,
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCloseButton: true,
                    closeButtonHtml: '<i class="fas fa-times"></i>',
                    html: `
                  <form id="CambiarEstadoForm" action="@Url.Action("CambiarEstado","Operador")" method="post">
                    <div class="form-group text-left">
                      <label class="control-label" for="slcOS">Folios *</label>
                      <select class="form-control" id="slcOS" name="OrdenServicioId" >
                        <option value="null" selected disabled>Selecciona un Folio</option>
                      </select>
                    </div>
                    <div class="form-group text-right">
                      <small>* Campos obligatorios</small>
                    </div>
                  </form>
                  `,
                    onRender: () => {
                        console.log(listOS)
                        for (const list of listOS) {
                            $("#slcOS").append(`<option value="${list.OrdenServicio.Id}">${list.OrdenServicio.Folio}</option>`);
                        }
                    },
                    preConfirm: () => {
                        if ($("#slcOS").val() === null) {
                            $("#slcOS").attr("style", "border-color: #f27474!important;box-shadow: 0 0 2px #f27474!important;");
                        }
                        else {
                            $("#slcOS").removeAttr("style");
                        }
                        if ($("#slcOS").val() === null) {
                            Swal.showValidationMessage("Algún campo obligatorio está vacío");
                        }
                    }
                }).then(result => {
                    if (result.value) {
                        $("#CambiarEstadoForm").submit();
                    }
                    else {
                        Swal.close();
                    }
                });
            });
        </script>
    }
    else
    {
        <script>
            $('#tableOrdenesServicio').on('click-row.bs.table', (row, $element, field) => {
                Swal.fire({
                    title: `Orden: ${$element.folio}`,
                    showConfirmButton: false,
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCloseButton: true,
                    closeButtonHtml: '<i class="fas fa-times"></i>',
                    html: `
                            <div class="form-row margTop40">
                                <div class="form-group col">
                                    <a href="@Url.Action("DownloadOSFormat","Servicio")?ordenId=${$element.id}" class="btn btn-success float" data-toggle="tooltip" data-placement="bottom" title="Descargar" data-original-title="Tooltip on bottom"><i class="fas fa-file-download"></i></a>
                                    <label class="d-block margTop5px">Descargar (ESP)</label>
                                </div>
                                <div class="form-group col">
                                    <a href="@Url.Action("DownloadOSFormatEnglish","Servicio")?ordenId=${$element.id}" class="btn btn-success float" data-toggle="tooltip" data-placement="bottom" title="Descargar" data-original-title="Tooltip on bottom"><i class="fas fa-file-download"></i></a>
                                    <label class="d-block margTop5px">Descargar (ENG)</label>
                                </div>
                            </div>
                            <div class="form-row margTop40">
                                <div class="form-group col">
                                    <a href="@Url.Action("AuditCard","Servicio")?osId=${$element.id}" class="btn btn-success float" data-toggle="tooltip" data-placement="bottom" title="Auditoría" data-original-title="Tooltip on bottom"><i class="fas fa-tasks"></i></a>
                                    <label class="d-block margTop5px">Auditoría</label>
                                </div>
                                <div class="form-group col">
                                    <a href="@Url.Action("IndexDetailOS", "Servicio")?ordenId=${$element.id}" class="btn btn-success float" data-toggle="tooltip" data-placement="bottom" title="Detalles" data-original-title="Tooltip on bottom"><i class="fas fa-search"></i></a>
                                    <label class="d-block margTop5px">Detalles</label>
                                </div>
                                <div class="form-group col">
                                    <a href="@Url.Action("IndexEditOS", "Servicio" )?ordenId=${$element.id}" class="btn btn-success float" data-toggle="tooltip" data-placement="bottom" title="Editar" data-original-title="Tooltip on bottom"><i class="fas fa-edit"></i></a>
                                    <label class="d-block margTop5px">Editar</label>
                                </div>

                                <!-- <div class="form-group col">
                                    <a onclick="btnDelete({'id':'${$element.id}', 'folio':'${$element.folio}'})" class="btn btn-success float" data-toggle="tooltip" data-placement="bottom" title="Eliminar" data-original-title="Tooltip on bottom"><i class="fas fa-trash"></i></a>
                                    <label class="d-block margTop5px">Eliminar</label>
                                </div> -->
                            </div>
                        `
                });
            });

            const btnDelete = (data) => {
                event.stopPropagation();
                Swal.fire({
                    icon: 'error',
                    title: `La Órden de Servicio ${data.folio} se eliminará`,
                    text: `¿Seguro que deseas eliminarlo?`,
                    reverseButtons: true,
                    showCancelButton: true,
                    confirmButtonText: "Si, Eliminar",
                    cancelButtonText: "No, Cancelar",
                    confirmButtonColor: "#E74C3C",
                    cancelButtonColor: "#67E7CF",
                    allowOutsideClick: false,
                    allowEscapeKey: false,
                    showCloseButton: true,
                    closeButtonHtml: '<i class="fas fa-times"></i>'
                }).then((result) => {
                    if (result.value) {
                        $("#btnSubmit").click();
                        $.ajax({
                            url: '@Url.Action("Delete","Servicio")',
                            method: "POST",
                            data: {
                                osid: data.id
                            },
                            async: true,
                            dataType: "json",
                            success: function(res) {
                                Swal.fire({
                                    icon: 'success',
                                    title: '¡Éxito!',
                                    text: `La Órden de Servicio ${data.folio} ha sido eliminada`,
                                    onClose: () => {
                                        location.reload(true);
                                    }
                                }).then((result) => {
                                    if (result.value) {
                                        location.reload(true);
                                    }
                                })
                            }
                        });
                    }
                    else {
                        Swal.close();
                    }
                });
            }
        </script>
    }
}